<html>
  <head>
    <script type="text/javascript" src="../js/jquery.js"></script>
    <script type="text/javascript" src="../js/bootstrap.js"></script>

    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" type="text/css"/>
    <script src="https://code.jquery.com/ui/1.10.0/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>

    <script>
      $(function () {
        <% if @ch_cd != "" %>
          $('select[id="select_channel"]').val('<%= @ch_cd %>');
        <% end %>

        <% if @shop_cd != "" %>
          $('select[id="select_shop"]').val('<%= @shop_cd %>');
        <% end %>

        $("#start_date").datepicker({
                    dateFormat: 'yy-mm-dd',
                    dayNamesMin: [
                        '일',
                        '월',
                        '화',
                        '수',
                        '목',
                        '금',
                        '토'
                    ],
                    monthNamesShort: [
                        '1월',
                        '2월',
                        '3월',
                        '4월',
                        '5월',
                        '6월',
                        '7월',
                        '8월',
                        '9월',
                        '10월',
                        '11월',
                        '12월'
                    ],
                    currentText: '오늘 날짜',
                    changeMonth: true
                });
            $("#end_date").datepicker({
                        dateFormat: 'yy-mm-dd',
                        dayNamesMin: [
                            '일',
                            '월',
                            '화',
                            '수',
                            '목',
                            '금',
                            '토'
                        ],
                        monthNamesShort: [
                            '1월',
                            '2월',
                            '3월',
                            '4월',
                            '5월',
                            '6월',
                            '7월',
                            '8월',
                            '9월',
                            '10월',
                            '11월',
                            '12월'
                        ],
                        currentText: '오늘 날짜',
                        changeMonth: true
                    });

          $("#date_init").click(function(){
            $("#start_date").datepicker('setDate', '<%= @start_date %>');
            $("#end_date").datepicker('setDate', '<%= @today %>');
            // load();
          });

          $("#age_init").click(function(){
            document.getElementById("start_age").value = '<%= @min_age %>'
            document.getElementById("end_age").value = '<%= @max_age %>'
          });

          $("#start_date").datepicker('setDate', '<%= @start_date %>');
          $("#end_date").datepicker('setDate', '<%= @end_date %>');

          document.getElementById("start_age").value = '<%= @min_age %>'
          document.getElementById("end_age").value = '<%= @max_age %>'

          <% if !@start_age.nil? %>
            document.getElementById("start_age").value = '<%= @start_age %>'
          <% end %>
          <% if !@end_age.nil? %>
            document.getElementById("end_age").value = '<%= @end_age %>'
          <% end %>

          <% if !@name.nil? %>
            document.getElementById("name").value = decode_utf8('<%= @name %>')
          <% end %>

          <% if !@sex.nil? %>
            $('select[id="select_sex"]').val('<%= @sex %>');
          <% end %>

          <% if !@select_base.nil? %>
            $('select[id="select_base"]').val('<%= @select_base %>');
          <% end %>

          <% if !@select_ample1.nil? %>
            $('select[id="select_ample_1"]').val('<%= @select_ample1 %>');
          <% end %>

          <% if !@select_ample2.nil? %>
            $('select[id="select_ample_2"]').val('<%= @select_ample2 %>');
          <% end %>

          <% if !@select_interview.nil? %>
            $('select[id="select_interview"]').val('<%= @select_interview %>');
          <% end %>

          $('#submit').click(function(){
            load();
          });

          $(document).on("click", ".table_tr", function (e) {
            console.log($(this).attr('id'));
            var userId = $(this).attr('id').split("/")[0]
            var after_interview_id = $(this).attr('id').split("/")[1]
            console.log(userId);
            console.log(after_interview_id);
            window.open("/admin/feedbacks/detail?userId=" + userId +"&after_interview_id=" +after_interview_id , "/feedbacks/detail?userId=" + userId +"&after_interview_id=" +after_interview_id, "scrollbars=1,resizable=1,height=500,width=600");
          });
      });

      function load(){
        var select_base = document.getElementById("select_base").options[document.getElementById("select_base").selectedIndex].value;
        var select_ample1 = document.getElementById("select_ample_1").options[document.getElementById("select_ample_1").selectedIndex].value;
        var select_ample2 = document.getElementById("select_ample_2").options[document.getElementById("select_ample_2").selectedIndex].value;
        var select_sex = document.getElementById("select_sex").options[document.getElementById("select_sex").selectedIndex].value;
        var select_interview = document.getElementById("select_interview").options[document.getElementById("select_interview").selectedIndex].value;
        var ch_cd = document.getElementById("select_channel").options[document.getElementById("select_channel").selectedIndex].value;
        var shop_cd = document.getElementById("select_shop").options[document.getElementById("select_shop").selectedIndex].value;

        url = ""
        url += "/admin/feedback_list?start_date=" + $('#start_date').val() + "&end_date=" + $('#end_date').val();
        url += "&sex=" + select_sex;
        url += "&start_age=" + document.getElementById("start_age").value;
        url += "&end_age=" + document.getElementById("end_age").value;
        url += "&select_base=" + select_base;
        url += "&select_ample1=" + select_ample1;
        url += "&select_ample2=" + select_ample2;
        url += "&select_interview=" + select_interview;
        url += "&name=" + encodeURI(encodeURI(document.getElementById("name").value));
        url += "&select_channel=" +ch_cd
        url += "&select_shop=" +shop_cd
        url += "&custserial=" +document.getElementById("custserial").value
        location.href = url;
      }

      function showDetail(userId, after_interview_id){
        window.open("/admin/feedbacks/detail?userId=" + userId +"&after_interview_id=" +after_interview_id , "/feedbacks/detail?userId=" + userId +"&after_interview_id=" +after_interview_id, "scrollbars=1,resizable=1,height=500,width=600");
      }

      function decode_utf8(s) {
        try{
          return decodeURI(s);
        }catch(err){
          console.log(err);
          return s;
        }
      }
    </script>
    <style>
    .fixed-table-body {
      max-height: 65%;
    }

    .text-center {
        margin: 0 auto;
        text-align: center !important;
    }

    .width170 {
      min-width:170px;
    }

    .width100 {
      min-width:100px;
    }

    .max-width600 {
      max-width:600px;
    }

    .width1800 {
      width:1800px;
    }

    table.width1800.table.table-hover {
      width: 1800px;
    }

    </style>
  </head>

  <body>
    <%= render "admin/header" %>

    <div id="filter" style="background: #b1cbbb; padding: 8px;">
      <div class="form-inline">
        진단 날짜 : <input class="form-control" type="text" id="start_date" style="width:100px;">
        <input class="form-control" type="text" id="end_date" style="width:100px;">
        <button id="date_init" class="btn btn-primary">ALL</button>
        <p style="float:right; margin-right:20px;">
          Download:
          <%= link_to "Excel", admin_feedback_list_path(format: "xlsx", :start_date => @start_date, :end_date => @end_date, :sex => @sex, :start_age => @start_age, :end_age => @end_age, :select_base => @select_base, :select_ample1 => @select_ample1, :select_ample2 => @select_ample2, :select_interview => @select_interview, :name => @name, :isExcel => true) %>
        </p>
      </div>

      <div class="form-inline">
        이름 :
        <input class="form-control" type="text" id="name" style="width:100px;">

        시리얼 :
        <input class="form-control" type="text" id="custserial" style="width:100px;">

        유형 :
        <select class="form-control" id="select_interview">
          <option value="all">All</option>
          <option value="today">당일</option>
          <option value="2weeks_ago">2주 전</option>
          <option value="3months_ago">3개월 전</option>
        </select>

        성별 :
        <select class="form-control" id="select_sex">
          <option value="all">All</option>
          <option value="F">여자</option>
          <option value="M">남자</option>
        </select>

        나이 :
        <input class="form-control" type="text" id="start_age" style="width:100px; margin-top:10px;">
        <input class="form-control" type="text" id="end_age" style="width:100px; margin-top:10px;">
        <button id="age_init" class="btn btn-primary">ALL</button>
      </div>

      <div class="form-inline">
        베이스제품 :
        <select class="form-control" id="select_base">
          <option value="all">All</option>
          <option value="skin control">스킨 컨트롤 세럼</option>
          <option value="deep humect">딥 휴멕트 세럼</option>
          <option value="rebalencing">리밸런싱 세럼</option>
        </select>

        앰플 1 :
        <select class="form-control" id="select_ample_1">
          <option value="all">All</option>
          <option value="pore clinic ampoule">포어 클리닉 앰플</option>
          <option value="carming ampoule">카밍 앰플</option>
          <option value="luminus ampoule">루미너스 앰플</option>
          <option value="regenerating ampoule">리제네리이팅 앰플</option>
          <option value="perming ampoule">퍼밍 앰플</option>
        </select>

        앰플 2 :
        <select class="form-control" id="select_ample_2">
          <option value="all">All</option>
          <option value="pore clinic ampoule">포어 클리닉 앰플</option>
          <option value="carming ampoule">카밍 앰플</option>
          <option value="luminus ampoule">루미너스 앰플</option>
          <option value="regenerating ampoule">리제네리이팅 앰플</option>
          <option value="perming ampoule">퍼밍 앰플</option>
        </select>

        채널 :
        <select class="form-control" id="select_channel" style="margin-left: 5px;">
          <option value="ALL">ALL</option>
          <option value="CNP">CNP</option>
          <option value="MART">마트</option>
          <option value="NC">NC</option>
          <option value="BEAU">보떼</option>
          <option value="LABO">LABO</option>
          <option value="CLAB">CLAB</option>
        </select>

        매장 이름 :
        <select class="form-control" id="select_shop" style="margin-left: 5px;">
        <option id="LABO" value="ALL">ALL</option>
          <option id="LABO" value="1001">LG연구소</option>
          <option id="LABO" value="1002">젠스토리</option>
          <option id="LABO" value="1003">LG에스타워 보떼</option>
          <option id="CLAB" value="1004">LG에스타워 CNP</option>
          <option id="TMR" value="304639">NC 인천 올리브점</option>
          <option id="BEAU" value="505415">수지 상현점</option>
          <option id="BEAU" value="504130">파주 금촌점</option>
          <option id="MART" value="505488">홈플러스 월드컵점</option>
          <option id="TMR" value="304401">NC 안산 상록수점</option>
          <option id="CNP" value="59100">르메디바이씨앤피 이대점</option>
          <option id="TMR" value="304369">NC 신촌점</option>
        </select>

        <button class="btn btn-warning" id="submit">조회</button>
      </div>
    </div>

    <div>
      <div>
        <div id="avr" style="background: #eea29a; padding: 8px;">
          총 인원 수 : <%= @count %> / 설문 1의 평균 점수 : <%= @average_a1 %> / 설문 2의 평균 점수 : <%= @average_a2 %> / 설문 3의 평균 점수 : <%= @average_a3 %> / 설문 4의 평균 점수 : <%= @average_a4 %><br>
        </div>

        <table data-toggle="table" class="width1800">
          <thead>
            <tr>
                <th class="text-center">이름</th>
                <th class="width100 text-center">설문 날짜</th>
                <th class="width170 text-center">진단 날짜</th>
                <th>성별</th>
                <th>나이</th>
                <th class="width170 text-center">베이스</th>
                <th class="width170 text-center">앰플 1</th>
                <th class="width170 text-center">앰플 2</th>
                <th>설문 1</th>
                <th>설문 2</th>
                <th>설문 3</th>
                <th>설문 4</th>
                <th class="max-width600 text-center">기타의견</th>
            </tr>
          </thead>
          <tbody>
            <% @after_interviews.each do |after_interview| %>
            <%= render partial: "admin/feedback/after_item", locals: { after_interview: after_interview } %>
            <% end %>
          </tbody>
        </table>

        <div>
          <%= paginate @after_interviews %>
        </div>
      </div>
    </div>
  </body>
</html>
